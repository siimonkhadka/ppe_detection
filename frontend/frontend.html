<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PPE Violation Detection with Webcam</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 20px auto;
    padding: 0 15px;
  }
  h2 {
    color: #333;
  }
  #resultImage, #video {
    max-width: 100%;
    border: 1px solid #ccc;
    margin-top: 15px;
  }
  #violations {
    margin-top: 15px;
  }
  .violation {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
  }
  .violation:last-child {
    border-bottom: none;
  }
  .face-img {
    width: 100px;
    border: 1px solid #aaa;
    margin-top: 5px;
    display: block;
  }
  #status {
    margin-top: 10px;
    font-weight: bold;
    color: #555;
  }
  #controls {
    margin-top: 20px;
  }
</style>
</head>
<body>

<h2>Upload Image for PPE Violation Detection</h2>
<input type="file" id="imageUpload" accept="image/*" />
<button id="startWebcam">Start Webcam Detection</button>
<button id="stopWebcam" disabled>Stop Webcam</button>

<div id="status">Please upload an image or start the webcam.</div>

<video id="video" autoplay playsinline style="display:none;"></video>
<img id="resultImage" alt="Annotated image will appear here" />
<div id="violations"></div>

<div id="controls"></div>

<script>
const backendUrl = 'http://127.0.0.1:8000';

const imageUpload = document.getElementById('imageUpload');
const resultImage = document.getElementById('resultImage');
const violationsDiv = document.getElementById('violations');
const statusDiv = document.getElementById('status');

const video = document.getElementById('video');
const startWebcamBtn = document.getElementById('startWebcam');
const stopWebcamBtn = document.getElementById('stopWebcam');

let webcamStream;
let webcamInterval;

imageUpload.addEventListener('change', async () => {
  stopWebcamDetection();

  const file = imageUpload.files[0];
  if (!file) return;

  statusDiv.textContent = "Processing image...";
  violationsDiv.innerHTML = "";
  resultImage.src = "";
  video.style.display = "none";
  resultImage.style.display = "block";

  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch(`${backendUrl}/detect/`, {
      method: 'POST',
      body: formData,
    });

    if (!response.ok) throw new Error(`Upload failed with status ${response.status}`);

    const data = await response.json();
    resultImage.src = `data:image/jpeg;base64,${data.annotated_image_base64}`;
    statusDiv.textContent = "Image processed. Fetching violations...";

    const violationsResp = await fetch(`${backendUrl}/violations/${data.image_id}`);
    if (!violationsResp.ok) throw new Error(`Failed to fetch violations: ${violationsResp.status}`);

    const violationsData = await violationsResp.json();

    if (violationsData.length === 0) {
      violationsDiv.textContent = "No violations detected.";
      statusDiv.textContent = "Done.";
      return;
    }

    violationsDiv.innerHTML = "";
    violationsData.forEach(v => {
      violationsDiv.innerHTML += `
        <div class="violation">
          <b>${v.label}</b> — Confidence: ${v.confidence} — Person ID: ${v.person_id}<br />
          <img src="${backendUrl}/${v.face_path}" alt="Face crop" class="face-img" />
        </div>
      `;
    });

    statusDiv.textContent = `Detected ${violationsData.length} violation(s).`;
  } catch (err) {
    statusDiv.textContent = "Error: " + err.message;
  }
});

// Webcam detection functions
startWebcamBtn.addEventListener('click', async () => {
  violationsDiv.innerHTML = "";
  statusDiv.textContent = "Starting webcam...";
  imageUpload.value = "";

  try {
    webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = webcamStream;
    video.style.display = "block";
    resultImage.style.display = "none";

    startWebcamBtn.disabled = true;
    stopWebcamBtn.disabled = false;

    // Send a frame every 3 seconds to backend for detection
    webcamInterval = setInterval(captureAndDetect, 3000);
    statusDiv.textContent = "Webcam running. Detection every 3 seconds.";
  } catch (err) {
    statusDiv.textContent = "Error accessing webcam: " + err.message;
  }
});

stopWebcamBtn.addEventListener('click', () => {
  stopWebcamDetection();
  statusDiv.textContent = "Webcam stopped.";
});

function stopWebcamDetection() {
  if (webcamInterval) clearInterval(webcamInterval);
  if (webcamStream) {
    webcamStream.getTracks().forEach(track => track.stop());
    webcamStream = null;
  }
  video.style.display = "none";
  resultImage.style.display = "block";
  startWebcamBtn.disabled = false;
  stopWebcamBtn.disabled = true;
  violationsDiv.innerHTML = "";
}

async function captureAndDetect() {
  if (!webcamStream) return;

  statusDiv.textContent = "Capturing frame and detecting...";

  // Create a canvas to grab frame
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Convert canvas to blob
  canvas.toBlob(async blob => {
    if (!blob) return;

    const formData = new FormData();
    formData.append('file', blob, 'webcam.jpg');

    try {
      const response = await fetch(`${backendUrl}/detect/`, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) throw new Error(`Detection failed: ${response.status}`);

      const data = await response.json();

      resultImage.src = `data:image/jpeg;base64,${data.annotated_image_base64}`;

      // Fetch violations for this image
      const violationsResp = await fetch(`${backendUrl}/violations/${data.image_id}`);
      if (!violationsResp.ok) throw new Error(`Failed to fetch violations: ${violationsResp.status}`);

      const violationsData = await violationsResp.json();

      violationsDiv.innerHTML = "";
      violationsData.forEach(v => {
        violationsDiv.innerHTML += `
          <div class="violation">
            <b>${v.label}</b> — Confidence: ${v.confidence} — Person ID: ${v.person_id}<br />
            <img src="${backendUrl}/${v.face_path}" alt="Face crop" class="face-img" />
          </div>
        `;
      });

      statusDiv.textContent = `Detected ${violationsData.length} violation(s).`;
    } catch (err) {
      statusDiv.textContent = "Error: " + err.message;
    }
  }, 'image/jpeg');
}
</script>

</body>
</html>
